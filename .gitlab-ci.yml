variables:
  workdir: "${CI_PROJECT_DIR}"
  ospath: ""

image:
  name: hashicorp/packer
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

stages:
  - validate
  - deploy

packer-validate:
  stage: validate

  script:
    - echo "packer validate ... "
    - packer validate "$workdir/$ospath"  build.json

  only:
    - main
    - test

mysql:
    extends: packer-validate
    variables:
        ospath: "$SCRIPT_PATH/mysql/"  

nginix:
    extends: packer-validate
    variables:
        ospath: "$SCRIPT_PATH/nginix/" 
    

packer-build:
  stage: deploy

  script:
    - echo "packer build-deploy ... "
    - packer build -force "$workdir/$ospath" build.json

  only:
    - main
    - tags
  when: manual  

mysql:
    extends: packer-build
    variables:
        ospath: "$SCRIPT_PATH/mysql/"  

nginix:
    extends: packer-build
    variables:
        ospath: "$SCRIPT_PATH/nginix/" 
  